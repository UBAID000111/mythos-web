<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create Your Custom T-Shirt - Mythos Arts</title>
  <style>
    body { background: #f9f9f9; text-align: center; padding: 10px; font-family: Arial, sans-serif; }
    header h2 { margin-bottom: 10px; color: #222; font-size: 22px; }

    .designer-box {
      max-width: 600px;
      margin: auto;
      background: #fff;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 3px 12px rgba(0,0,0,0.15);
    }

    .tshirt-container {
      position: relative;
      width: 400px;
      height: 500px;
      margin: 15px auto;
      touch-action: none;
    }

    @media(max-width:768px){
      .tshirt-container{
        width: 300px;
        height: 400px;
      }
    }

    .base-tshirt {
      width: 100%;
      display: block;
    }

    #uploadedImage {
      position: absolute;
      top: 120px;
      left: 50%;
      transform: translateX(-50%) rotate(0deg);
      max-width: 180px;
      cursor: move;
      display: none;
    }

    .resize-handle {
      position: absolute;
      width: 18px;
      height: 18px;
      bottom: -10px;
      right: -30px;
      background: white;
      border: 1px solid #333;
      border-radius: 3px;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: nwse-resize;
      font-size: 12px;
      font-weight: bold;
      user-select: none;
    }

    .controls { margin: 10px 0; }
    select, input[type=file] {
      padding: 8px;
      margin: 6px;
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 80%;
      font-size: 14px;
    }

    .btn-main {
      background: #27ae60;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      margin-top: 12px;
      width: 85%;
    }

    .btn-back {
      background: #444;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 6px;
      margin-top: 12px;
      cursor: pointer;
      width: 85%;
    }

    .btn-reset {
      background: #e67e22;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 6px;
      margin-top: 8px;
      cursor: pointer;
      width: 85%;
    }
  </style>
</head>
<body>
  <header>
    <h2>üé® Customize Your T-Shirt</h2>
  </header>

  <div class="designer-box">
    <div class="controls">
      <select id="colorSelect">
        <option value="black">üñ§ Black</option>
        <option value="white">ü§ç White</option>
        <option value="grey">ü©∂ Grey</option>
      </select>
      <br/>
      <select id="sideSelect">
        <option value="front">Front</option>
        <option value="back">Back</option>
      </select>
      <br/>
      <input type="file" id="uploadInput" accept="image/png, image/jpeg" />
    </div>

    <div class="tshirt-container" id="tshirtContainer">
      <img id="baseTshirt" class="base-tshirt" src="https://live.staticflickr.com/65535/54695438105_cb5e8a0b43_b.jpg" />
      <img id="uploadedImage" />
      <div class="resize-handle" id="resizeHandle">‚Üî</div>
    </div>

    <button class="btn-main" id="saveBtn">‚úÖ Save Design & Add to Cart (‚Çπ599)</button>
    <button class="btn-reset" id="resetBtn">üîÑ Reset Design</button>
    <br/>
    <button class="btn-back" onclick="window.location.href='index.html'">‚¨Ö Back to Home</button>
  </div>

  <script>
    const colorSelect = document.getElementById("colorSelect");
    const sideSelect = document.getElementById("sideSelect");
    const baseTshirt = document.getElementById("baseTshirt");
    const uploadInput = document.getElementById("uploadInput");
    const uploadedImage = document.getElementById("uploadedImage");
    const resizeHandle = document.getElementById("resizeHandle");
    const saveBtn = document.getElementById("saveBtn");
    const resetBtn = document.getElementById("resetBtn");

    const tshirtImages = {
      black: { front: "https://live.staticflickr.com/65535/54695438105_cb5e8a0b43_b.jpg", back: "https://live.staticflickr.com/65535/54695350829_a3937db238_b.jpg" },
      white: { front: "https://live.staticflickr.com/65535/54695415200_07f6d364ff_b.jpg", back: "https://live.staticflickr.com/65535/54695298888_8099b06702_b.jpg" },
      grey: { front: "https://live.staticflickr.com/65535/54695311163_86dcdb0c50_b.jpg", back: "https://live.staticflickr.com/65535/54695311158_4e3b34a241_b.jpg" }
    };

    function updateBaseImage() {
      baseTshirt.src = tshirtImages[colorSelect.value][sideSelect.value];
    }
    colorSelect.addEventListener("change", updateBaseImage);
    sideSelect.addEventListener("change", updateBaseImage);

    uploadInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        uploadedImage.src = reader.result;
        uploadedImage.style.display = "block";
        uploadedImage.style.top = "120px";
        uploadedImage.style.left = "50%";
        uploadedImage.style.transform = "translateX(-50%) scale(1) rotate(0deg)";
        resizeHandle.style.display = "block";
        positionResizeHandle();
      };
      reader.readAsDataURL(file);
    });

    function positionResizeHandle() {
      resizeHandle.style.top = uploadedImage.offsetTop + uploadedImage.offsetHeight - 12 + "px";
      resizeHandle.style.left = uploadedImage.offsetLeft + uploadedImage.offsetWidth - 12 + "px";
    }

    // Dragging
    let isDragging = false, startX, startY, initialX, initialY;
    uploadedImage.addEventListener("mousedown", startDrag);
    uploadedImage.addEventListener("touchstart", startDrag);
    function startDrag(e){
      isDragging = true;
      startX = e.clientX || e.touches[0].clientX;
      startY = e.clientY || e.touches[0].clientY;
      initialX = uploadedImage.offsetLeft;
      initialY = uploadedImage.offsetTop;
    }
    document.addEventListener("mousemove", onDrag);
    document.addEventListener("touchmove", onDrag);
    function onDrag(e){
      if(!isDragging) return;
      const x = e.clientX || e.touches[0].clientX;
      const y = e.clientY || e.touches[0].clientY;
      uploadedImage.style.left = initialX + (x - startX) + "px";
      uploadedImage.style.top = initialY + (y - startY) + "px";
      positionResizeHandle();
    }
    document.addEventListener("mouseup", ()=> isDragging=false);
    document.addEventListener("touchend", ()=> isDragging=false);

    // Resize
    let isResizing = false, initialWidth, initialHeight, scale = 1, rotation = 0;
    resizeHandle.addEventListener("mousedown", startResize);
    resizeHandle.addEventListener("touchstart", startResize);
    function startResize(e){
      isResizing = true;
      initialWidth = uploadedImage.offsetWidth;
      initialHeight = uploadedImage.offsetHeight;
      startX = e.clientX || e.touches[0].clientX;
      startY = e.clientY || e.touches[0].clientY;
      e.stopPropagation();
    }
    document.addEventListener("mousemove", onResize);
    document.addEventListener("touchmove", onResize);
    function onResize(e){
      if(!isResizing) return;
      const x = e.clientX || e.touches[0].clientX;
      const y = e.clientY || e.touches[0].clientY;
      const diffX = x - startX;
      const diffY = y - startY;
      scale = (initialWidth + diffX) / initialWidth;
      rotation = diffY * 0.5;
      uploadedImage.style.transform = `translateX(-50%) scale(${scale}) rotate(${rotation}deg)`;
      positionResizeHandle();
    }
    document.addEventListener("mouseup", ()=> isResizing=false);
    document.addEventListener("touchend", ()=> isResizing=false);

    resetBtn.addEventListener("click", ()=>{
      uploadedImage.style.display = "none";
      resizeHandle.style.display = "none";
      uploadInput.value = "";
    });

    saveBtn.addEventListener("click", ()=>{
      if(uploadedImage.style.display === "none"){
        alert("Please upload your design!");
        return;
      }
      // Generate final merged canvas
      const canvas = document.createElement("canvas");
      canvas.width = baseTshirt.offsetWidth;
      canvas.height = baseTshirt.offsetHeight;
      const ctx = canvas.getContext("2d");

      const base = new Image();
      base.crossOrigin = "anonymous";
      base.src = baseTshirt.src;
      base.onload = ()=>{
        ctx.drawImage(base, 0, 0, canvas.width, canvas.height);
        const img = new Image();
        img.src = uploadedImage.src;
        img.onload = ()=>{
          
          // Get accurate relative position using bounding boxes
          const tshirtRect = baseTshirt.getBoundingClientRect();
          const designRect = uploadedImage.getBoundingClientRect();

          const scaleX = canvas.width / tshirtRect.width;
          const scaleY = canvas.height / tshirtRect.height;

          const drawX = (designRect.left - tshirtRect.left) * scaleX;
          const drawY = (designRect.top - tshirtRect.top) * scaleY;
          const drawWidth = designRect.width * scaleX;
          const drawHeight = designRect.height * scaleY;

          ctx.translate(drawX + drawWidth / 2, drawY + drawHeight / 2);
          ctx.rotate(rotation * Math.PI / 180);
          ctx.scale(scale, scale);
          ctx.drawImage(img, -drawWidth / 2, -drawHeight / 2, drawWidth, drawHeight);
          ctx.setTransform(1, 0, 0, 1, 0, 0);

          const finalImg = canvas.toDataURL("image/png");
          const cart = JSON.parse(localStorage.getItem("cart")) || [];
          cart.push({
            id: Date.now(),
            name: `Custom T-Shirt (${sideSelect.value})`,
            price: 599,
            img: finalImg,
            qty: 1
          });
          localStorage.setItem("cart", JSON.stringify(cart));
          window.location.href = "cart.html";
        }
      }
    });
  </script>
</body>
</html>
