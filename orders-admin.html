<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin - Orders | Mythos Arts</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <header>
    <div class="logo">
      <img src="https://live.staticflickr.com/65535/54688874864_1e7c7e544d_q.jpg">
      <h2>Mythos Admin Panel</h2>
    </div>
    <button class="btn" id="logoutBtn">Logout</button>
  </header>

  <h3 style="text-align:center;">All Orders</h3>
  <div class="products" id="ordersContainer"></div>

  <footer>&copy; 2025 Mythos Arts</footer>

  <script type="module">
    import { auth, db } from './firebase.js';
    import { collection, getDocs, query, orderBy } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
    import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';

    const ordersContainer = document.getElementById("ordersContainer");
    const logoutBtn = document.getElementById("logoutBtn");

    logoutBtn.onclick = async () => { await signOut(auth); window.location.href = "auth.html"; };

    onAuthStateChanged(auth, async (user) => {
      if (!user || user.email !== "ubaidji07@gmail.com") {
        alert("Access denied");
        window.location.href = "index.html";
        return;
      }

      const q = query(collection(db, "orders"), orderBy("timestamp", "desc"));
      const snapshot = await getDocs(q);
      const orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

      if (!orders.length) {
        ordersContainer.innerHTML = "<p style='text-align:center;'>No orders yet.</p>";
        return;
      }

      orders.forEach(order => {
        ordersContainer.innerHTML += `
          <div class="product-card">
            <h4>User: ${order.email}</h4>
            <p><strong>Name:</strong> ${order.name}</p>
            <p><strong>Phone:</strong> ${order.phone}</p>
            <p><strong>City:</strong> ${order.city}, ${order.pincode}</p>
            <p><strong>Address:</strong> ${order.address}</p>
            <p><strong>Total:</strong> ₹${order.total}</p>
            <p><strong>Status:</strong> ${order.status || 'Pending'}</p>
            <p><strong>Time:</strong> ${new Date(order.timestamp?.seconds * 1000).toLocaleString()}</p>
            <button class="btn" onclick='generateInvoice(${JSON.stringify(order)})'>Download Invoice</button>
          </div>
        `;
      });
    });

    window.generateInvoice = (order) => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(16);
      doc.text("Mythos Arts - Invoice", 20, 20);

      doc.setFontSize(12);
      doc.text(`Order by: ${order.name}`, 20, 40);
      doc.text(`Email: ${order.email}`, 20, 50);
      doc.text(`Phone: ${order.phone}`, 20, 60);
      doc.text(`Address: ${order.address}, ${order.city} - ${order.pincode}`, 20, 70);
      doc.text(`Total: ₹${order.total}`, 20, 90);
      doc.text(`Date: ${new Date(order.timestamp?.seconds * 1000).toLocaleString()}`, 20, 100);

      doc.text("Thank you for shopping with Mythos Arts!", 20, 130);
      doc.save(`invoice_${order.name}.pdf`);
    }
  </script>
</body>
</html>
